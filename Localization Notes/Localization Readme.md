# Localization Readme

## Also See

- NotePlan [[MMF - i18n]]

## Reflection on Localization System - June 2024

(Update July 2024: We're implementing our own system now, the other stuff in this note is mostly outdated.)

Today I tried some more TMS' (Translation Management Systems) with online editors and support for crowd-sourcing. I really don't want to commit to any of them. I don't think any are really great. I also came up with an idea for a custom solution that I think is going to be very good.

Find more detailed reflection here:  
- This Note (notes://showNote?identifier=7FD12D9A-05B7-498B-998E-5F7086CDC6DA) where I documented my experiences with different TMS and a bit of reflection on a custom system
- The commit message for (06333d1d419afbdcf65bff90bc97e5199992e9b5) where we reflect on the advantages of using .xcstrings instead of .strings and .stringsdict, and also how the approach compares to TMS.
- The message that starts with `I played around with a lot of these TMS systems` inside this ChatGPT conversation (https://chatgpt.com/share/e35f461c-18a3-4316-85ab-be48a99007ba)
    
To summarize the idea for the custom solution:

- The first idea is: .xcstrings files are great. If we use .xcstrings files, their inbuilt functionality replaces both our UpdateStrings script and our State of Localization script. 
    - We don't need the UpdateStrings script anymore since Xcode automatically keeps the .xcstrings files in sync with the source files. Xcode automaticlly adds a string to the .xcstrings file, when it is added in a source file. If a string is removed from a source file, then Xcode will mark it as 'Stale' in the .xcstrings file. The strings also don't become unordered (Actually you can sort them by different criteria in the UI). And the strings can't contain syntax errors anymore after editing, since we edit them in a GUI. All this together means our UpdateStrings script is totally obsolete. Which is great! 
    - We also don't need the State of Localization script anymore because Xcode automatically tracks when translations are missing, superfluous, or outdated compared to the development language strings, and it stores this info right in line with the key-value pairs so localizers can search for strings that need attention and then see the state of the string right in line - This basically solves all the issues we tried to solve with the State of Localization and it's a much better user experience to have this info inline compared to having to look up the state of the keys in the separate "State of Localization" document.
    - Another thing that's nice is that .xcloc files are just .json so they are really easy to work with in our custom scripts. So no more complicated regex application in a loop to parse the kv-pairs in our .strings files.
    - Finally, .xcstrings files can be converted from and to .xcloc files - and the 'state' stays never gets lost! 
        [Explainer: .xcloc can be edited like .cstrings files, but the main functional difference is that a) They can contain autogenerated screenshots from Xcode Tests. (Which could give valuable context to translators) and that b) there's one .xcloc file per language whereas all languages are part of one .xcstrings file. This makes the .xcloc files ideal for distributing to translators. I think having all languages in the same file could lead to annoying issues when multiple people work on translating different languages at the same time] 
        
- The second idea is: It's a little weird, but it's totally feasible to move all our localized text into .xcstrings files!
    - To move .md files over to .xcstrings, we could make .md file "Skeletons" that don't contain any real content, but just the structure of the document as well as placeholders for the actual content. Then we can load the actual content from the .xcstrings file and 'hydrate' the .md file skeleton to create an actual document. This requires a bit of custom scripting, but since .xcstrings is just .json it should be totally doable.
    - To move the MMF website over to .xcstrings, we also have to create a script that converts the .xcstrings file to a format that nuxt.js expects for it's localization strings, but this also shouldn't be too hard. Should be very similar to the parsing we do for the .md file. We also had to create a dummy Xcode project around the .xcstrings file so that we are able to export it as .xcloc. This is a bit weird but it works fine, and it's totally worth it.
    
- Then finally publish this info through a script that: 
    - Transforms all the .xcstrings files to .xcloc files and gathers them together
    - Analyses how far the translation progress is (this is really easy by analysing the .xcstrings files)
    - Uploads the .xcloc files and the .xcstrings files to a GitHub document so translators can see, along with the translation progress.
    - Perhaps also automatically imports the .xcloc files back into .xcstrings files on the mac-mouse-fix and mac-mouse-fix-helper repo. (Although I should probably review them manually, when I import them back, so maybe we don't need to automate this.)
    
- Users then just have to follow 4 Steps. 
    1. Download the .xcloc file for your language (after checking that it has less than 100% translation)
    2. Download Xcode (or perhaps another editor, but the ones I tried seemed very prone to break files, so maybe I should advise against this.)
    3. Open the file in Xcode and make all the checkmarks green
    4. Write a comment on GitHub and attach the finished file(s) or send me an email (We could include a little PDF document in the download which could contain links to where you can submit the files to make it super easy)
    
- Other ideas:
    - Try to make it streamlined, rewarding or fun for translators as possible! This is very important!
    - To keep .md and .vue files in sync with the .xcstrings files which they use, we'd have to come up with someting else. Perhaps we could somehow use `genstrings` and define a custom routine (The default 'routine' is 'NSLocalizedString)  
        -> Update: When extracting .xcloc files using `xcodebuild` the `routines` are specified in the `LOCALIZED_STRING_MACRO_NAMES` build setting. But I'm not sure there's a way to use `xcodebuild` or `genstrings` to extract strings from .md and .vue files. 
        -> Even if that works, I think we could only extract .strings files - not .xcstrings files - using those tools. We'd have to manually update the .xcstrings files given those generates .strings files. This would be annoying but should be doable. 
        - Either ways, this is not high priority though, this solution would basically just automatically add new keys to the .xcstrings files or mark unused keys as stale. We coulddd also put the English values into the source files (like it is the case with IB files) and then have our script sync that to the .xcstrings file and mark all the translations as "NEEDS REVIEW" if the base translation changes... but I really think this is not important/necessary.  
    

## Reflection on Localization System - March 2024

Currently, MMF 3.0.1 is the latest release. The app has been translated into English, German, Chinese, Korean, Vietnamese. MMF 3.0.0 was released 2 months ago in December 2023. Shortly after, we created a new Translation Guide on GitHub. The guide is quite technical and instructs users to use git and edit .strings files manually. There's also the "State of Localization" comment under that guide, which shows a detailed automatic analysis of the current translations and which ones might be missing or outdated, etc.

So far, all of the translations, except for Vietnamese, were done in the Beta phase (of MMF of more than a year), and not in the over 2 months since release. Although the sales numbers for MMF 3 are 10x now compared to the beta, and although we've written the Translation Guide. (During the Beta, there were no instructions how to localize the app at all, so only programmers familiar with Xcode could do it.)

Also, there are some (admittedly pretty hidden, IIRC) places, where I've added new strings that haven't been updated for Korean and Chinese. These translations in need of update, are being shown in the "State of Localization", but nobody has reacted, yet.

I think we have to conclude from these things, that our current localization system is not very effective.

**Ideas for improvement**

Summary:

- The best possible solution would probably be custom, not crowdin-based. The most important things we should change is to autogenerate .xcloc files along with autogenerated screenshots produced by XCUI tests. Then have users edit the .xcloc files and send them to me via a github comment or email, instead of having users manually edit .strings files and make pull requests and so on.
  - Update: Actually, what I forgot to consider in my crowdin-vs-custom reflection, is that crowdin would also help translate the MMF website. The custom solution wouldn't work with that I think? I guess we could autogenerate xliff files for the website? Should reflect on this more.
- Other QOL improvements for translators: We should probably add a "Help Translating MMF" link into the app, and probably split the "State of Localization" up into one document per language. We might also share the "State of Localization" "as a PDF instead of the the GitHub comment? (Not sure why I wanted to do that?). Maybe we could show users a simple overview of the languages showing which languages need updates (or maybe a progress bar next to each language.) alongside a link to the detailed State of Localization for that language and maybe the xcloc file for that language. 
- I think the whole 'manually editing string files' workflow has practically no benefits for users at that point except if they want to feel like hackers. 
- From how I understand and have experienced Crowdin, it would be an almost strictly worse experience for users than this custom solution, except that it would allow inline discussions and voting, but those features don't seem to be used much on LinearMouse. Edit: Glossaries do seem interesting, but not sure how much they are used in practise.
- I thought about financial incentives but we decided they are probably not a good idea for now because it's just complicated to do that well and it wouldn't make sense to compensate users who only update a few translations quickly for a new release - and I feel like those incremental updates might be the most important / hardest thing to incentivize. Not sure though Overall: Maybe we can try to do financial incentives later, but first we should work on making translation experience better.

Detailed Reflection:

- Crowdin: 
    - LinearMouse uses crowdin.com (https://crowdin.com/project/linearmouse) and their translation seems to be very successful. I read somewhere that crowdin offers free services to open source projects. I think crowdin might be the simplest solution and lead to the best results, since the ease of use should drive peoples engagement.

- Custom implementation: 
    - Alternatively to crowdin, we could try to improve our custom translation system to be much more user friendly - especially for non-programmers. Ideas for streamlining the process:
    - Put a 'Help Translate' link in the app or other prominent places - to drive engagement which should improve translation quality.
    - Make the translation guide as short, scannable, and non-technical as possible. Make the workflow based on autogenerated .xcloc file. Just tell users. "Download this file, update the translations with Xcode or some other nice app, then write a comment below and attach the file. Finally you'll get credit in Acknowledgements/UpdateNotes. Thanks!". Then maybe have an overview of the languages. For each language we can show how many percent translated it is, and also provide a link to download the "State of Localization" for that language as a nice PDF. Maybe we can also let people download an .xcloc file just for that language or sth.
    - If we do it like this, the experience should be much nicer and I'm sure there will be more engagement. However compared to crowdin (as far as I understand that) our custom solution still would differ in these important ways:
        - Custom solution vs Crowdin:
        - Crowdin might not provide all the detailed automatic analysis info from our State of Localization. However it provides other context info such as comments, history of what the translation value was, votes on the translations values, seeing AI generated suggestions inline. Users being able to request addition context information, and more. 
        - Experience with Crowdin:
            - I just improved some translations for LinearMouse using crowdin and I didn't like the experience that much. I was quite overwhelmed by the interface. (My brain feels cloudy so maybe it's me). There was approval rating stuff but all the languages were 0% approved? I even approved some stuff but approval ratings didn't go up? There were all these cost of translation calculators on the LinearMouse project? There's so many different tabs and submenus. When you enter a translation, the whole screen shifts to the next translation. Theres's a vote and a translate view for a language, but also a combined view for both that looks almost the same as the translate view? It was so confusing. Then I entered some translations and there was like zero feedback? I wondered 'how do I send this now'. But I think it was already sent. I just don't understand, how or if, I'll be credited and how this all works. 
            - Also, the commenting feature (Which I thought would be the killer feature for crowdin) wasn't much used at all from what I saw. Mostly it was just one dude translating most things in a .strings file without discussion or or revisions. However, I did see requests for screenshots in some places.
            - Overall, I think editing an .xcloc file and then uploading it is actually a much simpler experience than crowdin, which I didn't expect! It seems most of the 'crowd' features like comments and votes aren't that impactful because at the end of the day it's a few people taking responsiblity and doing the work. The main advantage I see for crowdin is that people can request context, which would make it easier for me to provide good context. Another possible advantage would be that it would be less work than a custom solution, but the whole current localization system took me like 1 or 2 weeks and was really fun and fast to write in Python even though it's very complex. So I think the time investment isn't a huge factor. Also, I just noticed that you can use `xcodebuild -includeScreenshots` together with XCUI test that produce screenshots to autogenerate screenshots! I think that makes a custom solution clearly the better choice in every way! Except perhaps when it comes to how much effort it is for us. 
            
- Financial incentives: 
    - We might give out bounties or other form of payments to translators. I think it would be financially totally sensible to give translators of some languages like Chinese a few hundred bucks. But if we give $300 to translators of all of the hundreds of other languages that barely drive any revenue, that's not really financially sensible I think. We could do different prices for different languages or do language bounties but that's so complicated..? Idk I don't like it. Might have to think about it more. But the biggest problem is that a lot of the work we want to incetivise people to do is maintenance. Updating outdated translations and so on. And that work would only be worth a few bucks financially. So I don't think anyone wants to send me their bank data or paypal for like 5 bucks? And if the initial translators get a few hundred bucks but then maintainers get nothing, that's also weird? I just don't like it. Overall, I think based on this thought process, money isn't a great incentive. I also think people want to translate stuff they like - even without financial compensation. Case in point LinearMouse. I think it just needs to be something people want to do. Make it easy, fun, engaging, whatever, but I don't think getting money involved is a good idea. At least not before we tried making the translation experience much better.

## .xcloc files

.xcloc files make it much easier for non-programmers to translate Mac Mouse Fix.

- See the main documentation here: https://developer.apple.com/documentation/xcode/exporting-localizations/
- See documentation on including screenshots in .xcloc files: https://developer.apple.com/documentation/xcode/creating-screenshots-of-your-app-for-localizers

- Go to **Xcode > Product > Export Localizations...** to get an .xcloc file. You can also generate from the command line with **xcodebuild -exportLocalizations** and include screenshots generated from **XCUI** tests using the **-includeScreenshots** argument. See the main documentation for that. 
- Make sure the Xcode build flag **Compiler to Extract Swift Strings** (aka SWIFT_EMIT_LOC_STRINGS) is set to YES so that the extracting works properly for swift (src: main documentation)

## Memory helpers

- Don't change the keys for NSLocalizedString()! Otherwise all the existing translations for the key don't work anymore.
- Building the App or the Helper executes the Localization/Code/UpdateStrings script. It orders the key-value-pairs and brings the comments up-to-date.
- To test layout
    - In build scheme, set argument `-NSConstraintBasedLayoutVisualizeMutuallyExclusiveConstraints YES`
    - In build scheme set pseudo language (e.g. double length)
- NSLocalizedString() convention: Example: `NSLocalizedString("enabled-toggle.hint", comment: "First draft: Mac Mouse Fix will stay enabled after you close it || Note: Some useful note")`
    - Update 29.08.2024: 
        New convention:
            `NSLocalizedString("enabled-toggle.hint", comment: "Note: Some useful note")`
        Explanation:
            We removed all the 'First draft:' stuff from the NSLocalizedString comment fields on 29.08.2024 in commit 0238020f56ddc0778605de23341876b631abebd8. 
            We originally added the 'First draft:' stuff so that localizers could see the English strings right in line as they are editing a .strings file. 
            However, with the new .xcstrings and .xcloc files, this is not needed anymore, since those show the English strings right in line by themselves.
        Sidenote: 
            The 'First draft:' strings were really just the original English strings. We called them 'First draft:' so that we were not promising the reader that 
                it's exactly the English string - in case we messed up keeping the 'First draft:' in sync with the real English string in the English .strings file.
                -> But none of this stuff matters anymore now because we removed the 'First draft:' strings.

## Notes

TODO: We're using `en` as language ID for English and `de` as language ID for German. It might be be better to use `en-US` and `de-DE`? Because that's more accurate and clear if ppl add regional variants such as `de-CH`? We're also using `en-US` and `de-DE` as identifiers on the mmf website and the `markdown_generator.py`. Update: We changed all German translations to lang code `de`, so it shows up neatly in State of Localization. For English it's not important that all the language IDs match since it's the development language and doesn't show up in the State of Localization anyways. 

## Basic Translation Guide

- https://medium.com/@mds6058/localization-in-ios-and-how-to-make-it-not-suck-3adcbc3ec08f
- Covers all the (confusing) basics and setup
- Barty crouch: 
    - https://github.com/Flinesoft/BartyCrouch
    - Autogenerates and updates `.strings` files. Super handy!
    - Also supports machine translation, and other cool stuff
    - Update: We built our own script to replace bartycrouch in Localization/Code

## Auto-translate menu items

- 1. https://stackoverflow.com/questions/4206008/avoid-translating-standard-menus-items-in-xcode-project
    - No good answers
    - https://github.com/core-code/MiscApps/tree/master/Translator
        - "Use at your own risk"
- 2. https://stackoverflow.com/questions/11784716/localizing-the-edit-menu-and-other-standard-menus
    - Localization using Apple Glossaries: https://douglashill.co/localisation-using-apples-glossaries/
        - Is a lot of hacky effort
- 3. Maybe I could use Barty Crouch machine translations as a base and then just do the rest by hand
    - It uses Azure Translation. Should be free or extremely cheap but is a bit of work to set up. 

Conclusion: Didn't end up doing this.

## Tips for Localizers (Outdated)

- Enter a linebreak in .stringsdict using option + enter. '\n' doesn't work.
